name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  lint-and-format:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit black

      - name: Run pre-commit hooks
        run: pre-commit run --all-files --show-diff-on-failure

      - name: Check Black formatting
        run: black --check --diff .

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-html pytest-json-report pytest-cov pytest-md pytest-emoji

      - name: Run all tests
        run: |
          pytest tests/ \
            -v \
            --tb=short \
            --html=test-report-3.13.html \
            --self-contained-html \
            --json-report \
            --json-report-file=test-report-3.13.json \
            --junit-xml=junit-3.13.xml
        continue-on-error: true  # Some tests may fail due to API availability

      - name: Upload test reports and API responses
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-py3.13
          path: |
            test-report-*.html
            test-report-*.json
            junit-*.xml
            coverage-*.xml
            htmlcov-3.13/
            test-output/
          retention-days: 30

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage-3.13.xml
          flags: unittests
          name: codecov-py3.13
          fail_ci_if_error: false

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            junit-*.xml
          check_name: "Test Results (Python 3.13)"
          comment_title: "Test Results (Python 3.13)"
          report_individual_runs: true
          deduplicate_classes_by_file_name: false

      - name: Create test summary
        if: always()
        run: |
          echo "## Test Results Summary ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Python 3.13" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python3 .github/scripts/generate_test_summary.py \
            test-report-unit-3.13.json \
            coverage-3.13.xml >> $GITHUB_STEP_SUMMARY

          # Add API response summary if available
          if [ -f "test-output/api_responses.md" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## API Response Capture ðŸ“¡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat test-output/api_responses.md >> $GITHUB_STEP_SUMMARY
          fi
